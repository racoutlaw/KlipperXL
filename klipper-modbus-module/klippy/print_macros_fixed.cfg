# PRINT MACROS FOR ORCASLICER CUSTOM PROFILE
# ============================================================================
# NOTE: START_PRINT and END_PRINT are defined in printer.cfg
# This file contains helper macros only
# ============================================================================

# ----------------------------------------------------------------------------
# _ON_LAYER_CHANGE - Called before each layer
# ----------------------------------------------------------------------------
[gcode_macro _ON_LAYER_CHANGE]
description: Track layer changes
gcode:
    {% set LAYER = params.LAYER|default(0)|int %}
    {% set total = printer["gcode_macro _PRINT_VARIABLES"].total_layers|int %}

    SET_GCODE_VARIABLE MACRO=_PRINT_VARIABLES VARIABLE=current_layer VALUE={LAYER}

    # Calculate percentage
    {% if total > 0 %}
        {% set percent = ((LAYER / total) * 100)|round(1) %}
        RESPOND MSG="Layer {LAYER}/{total} ({percent}%)"
    {% else %}
        RESPOND MSG="Layer {LAYER}"
    {% endif %}

# ----------------------------------------------------------------------------
# _PRINT_VARIABLES - Storage for print state
# ----------------------------------------------------------------------------
[gcode_macro _PRINT_VARIABLES]
variable_total_layers: 0
variable_current_layer: 0
gcode:
    # This macro just stores variables

# ----------------------------------------------------------------------------
[gcode_macro PAUSE]
rename_existing: BASE_PAUSE
description: Pause the print
gcode:
    SAVE_GCODE_STATE NAME=PAUSE_state
    BASE_PAUSE
    G91
    G1 Z10 F600                  ; Lift Z
    G90
    G0 X10 Y10 F6000             ; Move to corner
    RESPOND MSG="Print paused"

# ----------------------------------------------------------------------------
# RESUME - Resume the print
# ----------------------------------------------------------------------------
[gcode_macro RESUME]
rename_existing: BASE_RESUME
description: Resume the print
gcode:
    RESPOND MSG="Resuming print..."

    # Prime the nozzle
    G91
    G1 E50 F300                  ; Reload filament
    G1 E5 F150                   ; Prime
    G90

    RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1 MOVE_SPEED=100
    BASE_RESUME

# ----------------------------------------------------------------------------
# CANCEL_PRINT - Cancel the print
# ----------------------------------------------------------------------------
[gcode_macro CANCEL_PRINT]
rename_existing: BASE_CANCEL_PRINT
description: Cancel the print
gcode:
    RESPOND MSG="Print cancelled"

    # Turn off heaters
    M104 S0
    M140 S0

    # Retract and lift
    G91
    G1 E-5 F1800
    G1 Z20 F600
    G90

    # Park
    G0 X10 Y300 F6000
    TOOL_PARK

    # Disable motors
    M84

    BASE_CANCEL_PRINT


# ============================================================================
# PROBE THRESHOLD MACROS - User adjustable from Mainsail
# ============================================================================

[gcode_macro SHOW_THRESHOLDS]
description: Show current probe threshold settings
gcode:
    PROBE_THRESHOLDS

[gcode_macro SET_Z_FAST]
description: Set Z fast probe threshold (default 60g)
gcode:
    {% set VALUE = params.VALUE|default(60)|float %}
    SET_Z_FAST_THRESHOLD VALUE={VALUE}

[gcode_macro SET_Z_SLOW]
description: Set Z slow probe threshold (default 40g)
gcode:
    {% set VALUE = params.VALUE|default(40)|float %}
    SET_Z_SLOW_THRESHOLD VALUE={VALUE}

[gcode_macro SET_MESH]
description: Set bed mesh probe threshold (default 60g)
gcode:
    {% set VALUE = params.VALUE|default(60)|float %}
    SET_MESH_THRESHOLD VALUE={VALUE}

[gcode_macro SET_XY]
description: Set XY calibration probe threshold (default 40g)
gcode:
    {% set VALUE = params.VALUE|default(40)|float %}
    SET_XY_THRESHOLD VALUE={VALUE}

# ============================================================================
# MODULAR BED MACROS - View individual bedlet temperatures
# ============================================================================

[gcode_macro SHOW_BED_TEMPS]
description: Show modular bed temperatures (4x4 grid)
gcode:
    BED_STATUS
