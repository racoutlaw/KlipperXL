# Prusa XL Klipper Configuration
# 
# This configuration includes:
# 1. PCA9557 I2C GPIO expander to release Dwarf toolheads from reset
# 2. MODBUS master module to communicate with Dwarf toolheads
#
# IMPORTANT: The PCA9557 MUST be configured to release Dwarfs from reset
# before MODBUS communication will work!

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32f407xx_XXXXXXXXX-if00

[printer]
kinematics: corexy
max_velocity: 500
max_accel: 10000
max_z_velocity: 20
max_z_accel: 200

#####################################################################
# PCA9557 I2C GPIO Expander - CRITICAL for Dwarf Reset Control
#####################################################################
# This MUST be enabled to release Dwarfs from reset!
# The XLBuddy holds all Dwarfs in reset via this I2C expander.
# Without this, the Dwarfs will have no lights and won't respond.

[pca9557]
i2c_bus: i2c2
i2c_address: 0x19
# On connect, this automatically sets all pins HIGH to release resets
# Pin mapping:
#   p0 = dwarf6Reset
#   p1 = dwarf1Reset  
#   p2 = dwarf2Reset
#   p3 = dwarf3Reset
#   p4 = dwarf4Reset
#   p5 = dwarf5Reset
#   p6 = fanPowerSwitch
#   p7 = modularBedReset

#####################################################################
# Enable 5V power to splitter/toolheads
#####################################################################

[output_pin splitter_5v]
pin: PE14
value: 1

#####################################################################
# XY Steppers (on XLBuddy)
#####################################################################

[stepper_x]
step_pin: PD7
dir_pin: !PD6
enable_pin: !PB9
microsteps: 16
rotation_distance: 40
endstop_pin: ^PG9
position_endstop: 0
position_max: 360
homing_speed: 50

[tmc2130 stepper_x]
cs_pin: PG15
spi_bus: spi3
run_current: 0.8
stealthchop_threshold: 0

[stepper_y]
step_pin: PD5
dir_pin: PD4
enable_pin: !PB9
microsteps: 16
rotation_distance: 40
endstop_pin: ^PE13
position_endstop: 0
position_max: 360
homing_speed: 50

[tmc2130 stepper_y]
cs_pin: PB5
spi_bus: spi3
run_current: 0.8
stealthchop_threshold: 0

#####################################################################
# Z Steppers (2 motors on XLBuddy)
#####################################################################

[stepper_z]
step_pin: PD3
dir_pin: PD2
enable_pin: !PB8
microsteps: 16
rotation_distance: 4
endstop_pin: probe:z_virtual_endstop
position_min: -2
position_max: 400
homing_speed: 10

[tmc2130 stepper_z]
cs_pin: PG10
spi_bus: spi3
run_current: 0.8
stealthchop_threshold: 0

[stepper_z1]
step_pin: PD1
dir_pin: PD0
enable_pin: !PB8
microsteps: 16
rotation_distance: 4

[tmc2130 stepper_z1]
cs_pin: PG10
spi_bus: spi3
run_current: 0.8
stealthchop_threshold: 0

#####################################################################
# Temperature Sensors
#####################################################################

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

[temperature_sensor raspberry_pi]
sensor_type: temperature_host
min_temp: 10
max_temp: 100
