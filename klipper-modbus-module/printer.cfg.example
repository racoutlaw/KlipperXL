# Prusa XL Klipper Configuration with MODBUS Dwarf Support
# 
# This configuration uses the native MODBUS master module to
# communicate with Dwarf toolheads via the XLBuddy's RS485 bus.
#
# IMPORTANT: This requires:
# 1. Klipper MCU firmware with modbus_stm32f4.c compiled in
# 2. Broken appendix to flash custom firmware
# 3. Dwarfs running stock Prusa firmware (unchanged)

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32f407xx_XXXXX-if00
# Find your serial with: ls /dev/serial/by-id/

[printer]
kinematics: corexy
max_velocity: 500
max_accel: 10000
max_z_velocity: 20
max_z_accel: 200

#####################################################################
# MODBUS Configuration
#####################################################################

[modbus_master]
# No configuration needed - uses fixed USART3 @ 230400 baud
# RS485 direction pin: PG1

#####################################################################
# Dwarf Toolheads
#####################################################################

[prusa_dwarf T0]
address: 1

[prusa_dwarf T1]
address: 2

[prusa_dwarf T2]
address: 3

[prusa_dwarf T3]
address: 4

[prusa_dwarf T4]
address: 5

#####################################################################
# XY Steppers (on XLBuddy)
#####################################################################

[stepper_x]
step_pin: PD7
dir_pin: PD6
enable_pin: !PB9
microsteps: 16
rotation_distance: 32
endstop_pin: tmc2130_stepper_x:virtual_endstop
position_min: 0
position_max: 360
position_endstop: 0
homing_speed: 50
homing_retract_dist: 0

[tmc2130 stepper_x]
cs_pin: PG15
spi_software_sclk_pin: PC10
spi_software_mosi_pin: PC12
spi_software_miso_pin: PC11
run_current: 0.9
stealthchop_threshold: 0
diag1_pin: ^!PG9
driver_SGT: 3

[stepper_y]
step_pin: PD5
dir_pin: !PD4
enable_pin: !PB9
microsteps: 16
rotation_distance: 32
endstop_pin: tmc2130_stepper_y:virtual_endstop
position_min: 0
position_max: 360
position_endstop: 0
homing_speed: 50
homing_retract_dist: 0

[tmc2130 stepper_y]
cs_pin: PB5
spi_software_sclk_pin: PC10
spi_software_mosi_pin: PC12
spi_software_miso_pin: PC11
run_current: 0.9
stealthchop_threshold: 0
diag1_pin: ^!PE13
driver_SGT: 3

#####################################################################
# Z Steppers (2 motors on XLBuddy)
#####################################################################

[stepper_z]
# Left Z motor
step_pin: PD3
dir_pin: !PD2
enable_pin: !PB8
microsteps: 16
rotation_distance: 4
endstop_pin: probe:z_virtual_endstop
position_min: -5
position_max: 360
homing_speed: 10

[tmc2130 stepper_z]
cs_pin: PG10
spi_software_sclk_pin: PC10
spi_software_mosi_pin: PC12
spi_software_miso_pin: PC11
run_current: 0.6
stealthchop_threshold: 0

[stepper_z1]
# Right Z motor
step_pin: PD1
dir_pin: !PD0
enable_pin: !PB8
microsteps: 16
rotation_distance: 4

[tmc2130 stepper_z1]
cs_pin: PF12
spi_software_sclk_pin: PC10
spi_software_mosi_pin: PC12
spi_software_miso_pin: PC11
run_current: 0.6
stealthchop_threshold: 0

#####################################################################
# Bed (placeholder - actual heating via MODBUS to ModularBed)
#####################################################################

[heater_bed]
heater_pin: PB0    # Placeholder
sensor_pin: PC0    # Placeholder
sensor_type: Generic 3950
control: pid
pid_Kp: 50
pid_Ki: 5
pid_Kd: 100
min_temp: 0
max_temp: 120

#####################################################################
# Extruder (placeholder - actual control via MODBUS to Dwarf)
# These settings are needed for Klipper to recognize tool T0
#####################################################################

[extruder]
# This is a virtual extruder - actual control goes through MODBUS
step_pin: PD1      # Placeholder (Dwarf controls actual stepper)
dir_pin: PD0       # Placeholder
enable_pin: !PD1   # Placeholder
microsteps: 16
rotation_distance: 7.71
nozzle_diameter: 0.4
filament_diameter: 1.75
heater_pin: PB1    # Placeholder
sensor_type: PT1000
sensor_pin: PA4    # Placeholder
control: pid
pid_Kp: 20
pid_Ki: 1.5
pid_Kd: 50
min_temp: 0
max_temp: 300
min_extrude_temp: 170

#####################################################################
# GCode Macros
#####################################################################

[gcode_macro START_PRINT]
gcode:
    G28                     ; Home all axes
    DWARF_SELECT TOOL=T0 SELECT=1
    M104 S200               ; Set hotend temp
    M190 S60                ; Wait for bed temp
    M109 S200               ; Wait for hotend temp
    G0 Z5 F3000             ; Move up
    G0 X10 Y10 F6000        ; Move to corner

[gcode_macro END_PRINT]
gcode:
    M104 S0                 ; Turn off hotend
    M140 S0                 ; Turn off bed
    G91                     ; Relative positioning
    G0 Z10 F1000            ; Raise Z
    G90                     ; Absolute positioning
    G0 X0 Y350 F6000        ; Park
    DWARF_SELECT TOOL=T0 SELECT=0
    M84                     ; Motors off

[gcode_macro CHANGE_TOOL]
gcode:
    {% set tool = params.T|default(0)|int %}
    ; Deselect current tool
    DWARF_SELECT TOOL=T0 SELECT=0
    DWARF_SELECT TOOL=T1 SELECT=0
    DWARF_SELECT TOOL=T2 SELECT=0
    DWARF_SELECT TOOL=T3 SELECT=0
    DWARF_SELECT TOOL=T4 SELECT=0
    ; Select new tool
    {% if tool == 0 %}
        DWARF_SELECT TOOL=T0 SELECT=1
    {% elif tool == 1 %}
        DWARF_SELECT TOOL=T1 SELECT=1
    {% elif tool == 2 %}
        DWARF_SELECT TOOL=T2 SELECT=1
    {% elif tool == 3 %}
        DWARF_SELECT TOOL=T3 SELECT=1
    {% elif tool == 4 %}
        DWARF_SELECT TOOL=T4 SELECT=1
    {% endif %}

#####################################################################
# Additional Settings
#####################################################################

[virtual_sdcard]
path: ~/printer_data/gcodes

[pause_resume]

[display_status]

[respond]
