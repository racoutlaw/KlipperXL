# PRINT MACROS FOR ORCASLICER CUSTOM PROFILE
# ============================================================================
# NOTE: START_PRINT and END_PRINT are defined in printer.cfg
# This file contains helper macros only
# ============================================================================

# ----------------------------------------------------------------------------
# _ON_LAYER_CHANGE - Called before each layer
# ----------------------------------------------------------------------------
[gcode_macro _ON_LAYER_CHANGE]
description: Track layer changes
gcode:
    {% set LAYER = params.LAYER|default(0)|int %}
    {% set total = printer["gcode_macro _PRINT_VARIABLES"].total_layers|int %}

    SET_GCODE_VARIABLE MACRO=_PRINT_VARIABLES VARIABLE=current_layer VALUE={LAYER}

    # Calculate percentage
    {% if total > 0 %}
        {% set percent = ((LAYER / total) * 100)|round(1) %}
        RESPOND MSG="Layer {LAYER}/{total} ({percent}%)"
    {% else %}
        RESPOND MSG="Layer {LAYER}"
    {% endif %}

# ----------------------------------------------------------------------------
# _PRINT_VARIABLES - Storage for print state
# ----------------------------------------------------------------------------
[gcode_macro _PRINT_VARIABLES]
variable_total_layers: 0
variable_current_layer: 0
gcode:
    # This macro just stores variables

# ----------------------------------------------------------------------------
# PAUSE - Prusa-matched pause behavior
# Prusa Reference: marlin_server.cpp, Configuration_XL.h
# ----------------------------------------------------------------------------
[gcode_macro PAUSE]
rename_existing: BASE_PAUSE
description: Pause the print
gcode:
    _status_paused
    SAVE_GCODE_STATE NAME=PAUSE_state
    BASE_PAUSE

    # Retract filament (Prusa: 1mm @ 10.8mm/s = 648 F)
    G91
    G1 E-1 F648

    # Lift Z (Prusa: 20mm rise, 5mm/s = 300 F)
    G1 Z20 F300
    G90

    # CRITICAL: Clear bed mesh before XY move to prevent compensation crash
    BED_MESH_CLEAR

    # Park at front left for filament reloading
    G0 X3 Y10 F6000

    RESPOND MSG="Print paused - nozzle parked at front left"

# ----------------------------------------------------------------------------
# RESUME - Resume the print
# ----------------------------------------------------------------------------
[gcode_macro RESUME]
rename_existing: BASE_RESUME
description: Resume the print
gcode:
    _status_printing
    RESPOND MSG="Resuming print..."

    # Prime the nozzle (match PAUSE retract: 1mm)
    G91
    G1 E1.5 F648                 ; Restore 1mm retract + small prime
    G90

    RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1 MOVE_SPEED=100
    BASE_RESUME

# ----------------------------------------------------------------------------
# CANCEL_PRINT - Cancel the print
# ----------------------------------------------------------------------------
[gcode_macro CANCEL_PRINT]
rename_existing: BASE_CANCEL_PRINT
description: Cancel the print
gcode:
    _status_error
    RESPOND MSG="Print cancelled"

    # CRITICAL: Turn off Klipper's heater FIRST to prevent verify_heater error
    M104 S0               # Klipper extruder heater target = 0
    M140 S0               # Bed off
    M106 S0               # Fan off

    # Turn off ALL tool heaters (Dwarfs 1-5) via MODBUS
    SET_DWARF_TEMP DWARF=1 TEMP=0
    SET_DWARF_TEMP DWARF=2 TEMP=0
    SET_DWARF_TEMP DWARF=3 TEMP=0
    SET_DWARF_TEMP DWARF=4 TEMP=0
    SET_DWARF_TEMP DWARF=5 TEMP=0

    # Retract and lift (Prusa: 1mm retract, 20mm Z lift)
    G91
    G1 E-1 F648
    G1 Z20 F300
    G90

    # CRITICAL: Clear bed mesh before XY move to prevent compensation crash
    BED_MESH_CLEAR

    # Park at back (Prusa: X=3, Y=350)
    G0 X3 Y350 F6000
    TOOL_PARK

    # Disable motors
    M84

    BASE_CANCEL_PRINT
    _status_idle


# ============================================================================
# PROBE THRESHOLD MACROS - User adjustable from Mainsail
# ============================================================================

[gcode_macro SHOW_THRESHOLDS]
description: Show current probe threshold settings
gcode:
    PROBE_THRESHOLDS

[gcode_macro SET_Z_FAST]
description: Set Z fast probe threshold (requires VALUE parameter)
gcode:
    {% if params.VALUE is defined %}
        SET_Z_FAST_THRESHOLD VALUE={params.VALUE|float}
    {% else %}
        RESPOND MSG="Usage: SET_Z_FAST VALUE=125 (Prusa default: 125g)"
    {% endif %}

[gcode_macro SET_Z_SLOW]
description: Set Z slow probe threshold (requires VALUE parameter)
gcode:
    {% if params.VALUE is defined %}
        SET_Z_SLOW_THRESHOLD VALUE={params.VALUE|float}
    {% else %}
        RESPOND MSG="Usage: SET_Z_SLOW VALUE=125 (Prusa default: 125g)"
    {% endif %}

[gcode_macro SET_MESH]
description: Set bed mesh probe threshold (requires VALUE parameter)
gcode:
    {% if params.VALUE is defined %}
        SET_MESH_THRESHOLD VALUE={params.VALUE|float}
    {% else %}
        RESPOND MSG="Usage: SET_MESH VALUE=125 (Prusa default: 125g)"
    {% endif %}

[gcode_macro SET_XY]
description: Set XY calibration probe threshold (requires VALUE parameter)
gcode:
    {% if params.VALUE is defined %}
        SET_XY_THRESHOLD VALUE={params.VALUE|float}
    {% else %}
        RESPOND MSG="Usage: SET_XY VALUE=40 (Prusa default: 40g)"
    {% endif %}

# ============================================================================
# TOOL LIGHT - Toggle nozzle light on active tool
# ============================================================================

[gcode_macro NOZZLE_LIGHT]
description: Toggle nozzle light on/off
gcode:
    TOOL_LIGHT

# ============================================================================
# MODULAR BED MACROS - View individual bedlet temperatures
# ============================================================================

[gcode_macro SHOW_BED_TEMPS]
description: Show modular bed temperatures (4x4 grid)
gcode:
    BED_STATUS
